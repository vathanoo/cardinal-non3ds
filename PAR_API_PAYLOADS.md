<!-- START GENAI -->
# PAR API Payloads - As Per Current Code

This document shows the exact PAR API payloads generated by the current implementation.

---

## 1. First PAR Call - Registration Flow (flowType: 'registration')

**Endpoint:** `POST /vpp/v1/passkeys/oauth2/authorization/request/pushed`

**Payload:**
```json
{
  "response_type": "code",
  "amr_values": ["pop#fido2"],
  "code_challenge_method": "S256",
  "response_mode": "com_visa_web_message",
  "client_assertion_type": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
  "ui_locales": ["en"],
  "authorization_details": [{
    "preferences": {
      "notification": {
        "email": "test@visa.com"
      }
    },
    "trustchain": {
      "anchor": {
        "authentication": [{
          "protocol": "TDS",
          "source_hint": "CRD",
          "amr": [],
          "source_id_hint": "ACS_TNX_ID",
          "source_id": "6c9e8b16-cfc8-48a9-bccc-ddfdc2f5bfe2",
          "time": "1768883176"
        }]
      },
      "surrogate": {
        "authentication": [{
          "amr_values": ["pop#fido2"],
          "time": ""
        }]
      }
    },
    "confinements": {
      "origin": {
        "source_hint": "SERVER_STATE"
      },
      "device": {
        "source_hint": "SERVER_STATE"
      }
    },
    "type": "com_visa_payment_credential_binding",
    "payee": {
      "origin": "www.bicycle.com",
      "name": "Bicycle Shop"
    },
    "payer": {
      "account": {
        "scheme": "com_visa_pan",
        "id": "XXXX"
      }
    }
  }],
  "scope": "openid",
  "state": "af0ifjsldkj&client_id=s6BhdRkqt3",
  "redirect_uri": "https://www.example-merchant.com/callback",
  "client_assertion": "<JWT_TOKEN>",
  "prompt": "create",
  "code_challenge": "qHsOxeX0xzaOv3F1sZDtdIiX32TpEIMtH8HVc8CbVBs",
  "server_state": "<redacted>"
}
```

**Key Points:**
- `prompt`: "create"
- `code_challenge`: Actual SHA256 hash value
- `type`: "com_visa_payment_credential_binding"
- Includes `trustchain` with anchor and surrogate authentication
- `time`: Unix timestamp as string
- `payee.origin`: Without protocol (e.g., "www.bicycle.com")

---

## 2. First PAR Call - Authentication Flow (flowType: 'authentication')

**Endpoint:** `POST /vpp/v1/passkeys/oauth2/authorization/request/pushed`

**Payload:**
```json
{
  "response_type": "code",
  "amr_values": ["pop#fido2"],
  "code_challenge_method": "S256",
  "response_mode": "com_visa_web_message",
  "client_assertion_type": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
  "ui_locales": ["en"],
  "authorization_details": [{
    "payee": {
      "origin": "www.bicycle.com",
      "name": "Bicycle Shop"
    },
    "preferences": {},
    "confinements": {
      "origin": {
        "source_hint": "SERVER_STATE"
      },
      "device": {
        "source_hint": "SERVER_STATE"
      }
    },
    "details": {
      "amount": "20.00",
      "currency": "USD",
      "label": "Total"
    },
    "type": "com_visa_payment_transaction",
    "payer": {
      "account": {
        "scheme": "com_visa_pan",
        "id": "XXXXX"
      }
    }
  }],
  "scope": "openid",
  "state": "af0ifjsldkj&client_id=s6BhdRkqt3",
  "redirect_uri": "https://www.example-merchant.com/callback",
  "client_assertion": "<JWT_TOKEN>",
  "prompt": "login",
  "code_challenge": "",
  "server_state": "<redacted>"
}
```

**Key Points:**
- `prompt`: "login"
- `code_challenge`: Empty string ""
- `type`: "com_visa_payment_transaction"
- `preferences`: Empty object {}
- Includes transaction `details` (amount, currency, label)
- No `trustchain` field
- `payee.origin`: Without protocol

---

## 3. Second PAR Call - Auto-Retry After notfound_amr_values Error

**Triggered When:** First authentication PAR returns `"error": "notfound_amr_values"`

**Endpoint:** `POST /vpp/v1/passkeys/oauth2/authorization/request/pushed`

**Payload:**
```json
{
  "response_type": "code",
  "amr_values": ["pop#fido2"],
  "code_challenge_method": "S256",
  "response_mode": "com_visa_web_message",
  "client_assertion_type": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
  "ui_locales": ["en"],
  "authorization_details": [{
    "payee": {
      "origin": "www.bicycle.com",
      "name": "Bicycle Shop"
    },
    "preferences": {},
    "confinements": {
      "origin": {
        "source_hint": "SERVER_STATE"
      },
      "device": {
        "source_hint": "SERVER_STATE"
      }
    },
    "details": {
      "amount": "20.00",
      "currency": "USD",
      "label": "Total"
    },
    "type": "com_visa_payment_transaction",
    "payer": {
      "account": {
        "scheme": "com_visa_pan",
        "id": "XXXXX"
      }
    }
  }],
  "scope": "openid",
  "state": "af0ifjsldkj&client_id=s6BhdRkqt3",
  "redirect_uri": "https://www.example-merchant.com/callback",
  "client_assertion": "<JWT_TOKEN>",
  "prompt": "login",
  "code_challenge": "",
  "server_state": "<redacted>"
}
```

**Key Points:**
- Same structure as authentication flow
- `prompt`: "login" (not "create")
- `type`: "com_visa_payment_transaction" (not binding)
- `code_challenge`: Empty string ""
- Automatically triggered when no passkey exists

---

## Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│ Client initiates payment with flowType='authentication'     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│ First PAR Call (Authentication)                             │
│ - prompt: "login"                                           │
│ - type: "com_visa_payment_transaction"                      │
│ - code_challenge: ""                                        │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
                    ┌────────┐
                    │ Result │
                    └───┬────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐           ┌──────────────────────┐
│ Success       │           │ notfound_amr_values  │
│ Return JWT    │           │ Error                │
└───────────────┘           └──────────┬───────────┘
                                       │
                                       ▼
                    ┌──────────────────────────────────────┐
                    │ Auto-Retry: Second PAR Call          │
                    │ - prompt: "login"                    │
                    │ - type: "com_visa_payment_transaction"│
                    │ - code_challenge: ""                 │
                    └──────────────────┬───────────────────┘
                                       │
                                       ▼
                                  ┌────────┐
                                  │ Result │
                                  └────────┘
```

---

## Code Location Reference

### routes/vpp.js
- **Lines 145-220**: Registration flow authorization_details
- **Lines 222-260**: Authentication flow authorization_details
- **Lines 280-360**: Auto-retry logic for notfound_amr_values

### services/VPPService.js
- **Lines 195-280**: createPushedAuthorizationRequest method
- **Lines 285-305**: transformToVisaAPIFormat method

---

## Environment Variables Used

- `MERCHANT_ORIGIN`: Merchant website origin (protocol stripped for payee.origin)
- `INTEGRATOR_ORIGIN`: Redirect URI
- `MERCHANT_NAME`: Payee name (default: "Bicycle Shop")
- `VPP_CLIENT_ID`: Client ID for JWT assertion

---

## Notes

1. **Field Order**: The code maintains the exact field order as specified in your requirements
2. **Protocol Stripping**: `payee.origin` automatically strips `https://` or `http://`
3. **Unix Timestamp**: Registration flow uses `Math.floor(Date.now() / 1000).toString()`
4. **Auto-Retry**: Seamlessly handles missing passkey scenario
5. **MLE Encryption**: If configured, the entire payload is encrypted before sending

<!-- END GENAI -->
